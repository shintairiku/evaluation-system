# Requirements Document

## Introduction

ステージ・コンピテンシー管理機能は、管理者がユーザーのステージを管理し、各ステージのコンピテンシーを編集できる包括的な管理システムです。この機能により、管理者はドラッグ&ドロップでユーザーのステージを変更し、コンピテンシーの詳細を管理できます。

## Requirements

### Requirement 1: ステージ管理ページ（管理者専用）

**User Story:** 管理者として、ユーザーのステージを視覚的に管理したいので、ドラッグ&ドロップでユーザーを異なるステージに移動できる機能が欲しい

#### Acceptance Criteria

1. WHEN 管理者がステージ管理ページにアクセスする THEN システムは Stages DB からステージデータ（名前、説明、作成日時、更新日時）を取得して表示する SHALL
2. WHEN ページが読み込まれる THEN システムは各ステージに所属するユーザーのリストを表示する SHALL
3. WHEN 管理者がユーザーカードをドラッグ&ドロップする THEN システムは編集モードを有効化する SHALL
4. WHEN 編集モード中 THEN 管理者は複数のユーザーを移動できる SHALL
5. WHEN 管理者が「保存」ボタンをクリックしない限り THEN システムはDBに変更を反映しない SHALL
6. WHEN 管理者が「保存」ボタンをクリックする THEN システムは UpdateUserStage エンドポイントを使用してユーザーのステージを更新する SHALL
7. WHEN 非管理者ユーザーがステージ管理ページにアクセスしようとする THEN システムは403 Forbiddenエラーでアクセスを完全に拒否する SHALL

### Requirement 2: ユーザーステージ更新API

**User Story:** 管理者として、ユーザーのステージを安全に更新したいので、管理者のみがアクセスできる専用のAPIエンドポイントが欲しい

#### Acceptance Criteria

1. WHEN 新しい UpdateUserStage エンドポイントが作成される THEN システムは管理者のみがアクセス可能にする SHALL
2. WHEN 既存のユーザー更新メソッドから stage_id が削除される THEN システムはRBACを安全に実装する SHALL
3. WHEN 管理者以外がUpdateUserStageエンドポイントにアクセスする THEN システムは403 Forbiddenエラーを返す SHALL
4. WHEN 有効な管理者がエンドポイントを呼び出す THEN システムはユーザーのステージを更新する SHALL

### Requirement 3: コンピテンシー管理ページ（役割ベースアクセス）

**User Story:** 管理者として、各ステージのコンピテンシーを管理したいので、コンピテンシーの詳細を表示・編集できるページが欲しい

#### Acceptance Criteria

1. WHEN 管理者またはビューワーがコンピテンシー管理ページにアクセスする THEN システムはトップセクションにステージ名と説明を表示する SHALL
2. WHEN ページが読み込まれる THEN システムは各ステージ列に複数行のコンピテンシー（名前と説明）を表示する SHALL
3. WHEN 管理者がコンピテンシーボックスをクリックする THEN システムは編集用のモーダルを開く SHALL
4. WHEN ビューワーがコンピテンシーボックスをクリックする THEN システムは何も実行せず、編集モーダルを開かない SHALL
5. WHEN 管理者用モーダルが開かれる THEN システムはコンピテンシーの名前、説明、作成日時、更新日時を表示する SHALL
6. WHEN モーダル内で管理者が「保存」ボタンをクリックする THEN システムはDBを更新する SHALL
7. WHEN モーダル内で管理者が「キャンセル」ボタンをクリックする THEN システムは変更を破棄してモーダルを閉じる SHALL
8. WHEN 非管理者・非ビューワーユーザーがコンピテンシー管理ページにアクセスしようとする THEN システムは403 Forbiddenエラーでアクセスを拒否する SHALL

### Requirement 4: コンピテンシー削除機能

**User Story:** 管理者として、不要なコンピテンシーを削除したいので、確認ダイアログ付きの削除機能が欲しい

#### Acceptance Criteria

1. WHEN 管理者がコンピテンシー編集モーダルで「削除」ボタンをクリックする THEN システムは削除確認ダイアログを表示する SHALL
2. WHEN 管理者が削除を確認する THEN システムはコンピテンシーをDBから削除する SHALL
3. WHEN 管理者が削除をキャンセルする THEN システムは削除処理を中止してモーダルに戻る SHALL
4. WHEN コンピテンシーが正常に削除される THEN システムはページを更新してコンピテンシーリストから削除されたアイテムを除外する SHALL

### Requirement 5: バックエンドAPI統合

**User Story:** フロントエンド開発者として、ステージとコンピテンシーデータを取得・更新したいので、適切なAPIエンドポイントが利用可能である必要がある

#### Acceptance Criteria

1. WHEN フロントエンドがステージデータを要求する THEN システムは既存のステージAPIエンドポイントからデータを提供する SHALL
2. WHEN フロントエンドがコンピテンシーデータを要求する THEN システムは既存のコンピテンシーAPIエンドポイントからデータを提供する SHALL
3. WHEN APIレスポンスが返される THEN システムは適切なエラーハンドリングとローディング状態を提供する SHALL
4. WHEN データの更新が発生する THEN システムはリアルタイムでUIを更新する SHALL

### Requirement 6: 権限管理とセキュリティ

**User Story:** システム管理者として、厳格な権限管理を実装したいので、適切な役割に基づいたアクセス制御を行いたい

#### Acceptance Criteria

1. WHEN 非管理者ユーザーがステージ管理ページにアクセスする THEN システムは403 Forbiddenエラーを返し、アクセスを完全に拒否する SHALL
2. WHEN 管理者がステージ管理ページにアクセスする THEN システムは完全な編集権限を提供する SHALL
3. WHEN 非管理者・非ビューワーユーザーがコンピテンシー管理ページにアクセスする THEN システムは403 Forbiddenエラーを返す SHALL
4. WHEN ビューワー役割のユーザーがコンピテンシー管理ページにアクセスする THEN システムは読み取り専用モードで表示し、編集モーダルへのアクセスを無効化する SHALL
5. WHEN 管理者がコンピテンシー管理ページにアクセスする THEN システムは完全な編集権限（モーダル含む）を提供する SHALL
6. WHEN 権限検証が必要な THEN システムはサーバーサイドで役割ベースの権限を確認する SHALL
7. WHEN 不正なアクセスが検出される THEN システムは適切なエラーメッセージを表示する SHALL
8. WHEN セッションが無効になる THEN システムはユーザーをログインページにリダイレクトする SHALL