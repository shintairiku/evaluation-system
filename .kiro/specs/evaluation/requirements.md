# 評価フロー要件定義（業績・コンピテンシー・360 コアバリュー）

本ドキュメントは、以下 3 区分の評価機能の要件を定義する。

- 業績目標に対する自己評価・上司評価
- コンピテンシーに対する自己評価・上司評価
- 360 度コアバリュー評価（自己・上司・同僚）

既存の目標設定・評価期間管理の仕組み（EvaluationPeriod, Goal など）を前提としつつ、評価ロジックとデータモデルを再定義する。

---

## 1. 共通概念

### 1.1 組織・評価期間・対象者

- **組織（Organization）**
  - マルチテナント前提。すべての評価・マスタは `organization_id` によりスコープされる。
- **評価期間（EvaluationPeriod）**
  - 半期・年次など、期間を表す既存モデルを利用する。
  - 本要件で扱うすべての評価は、必ず特定の評価期間に紐づく。
- **対象者（被評価者 / Evaluatee）**
  - 評価される従業員ユーザ。
  - 「組織 × 評価期間 × 対象者」が評価集計の最小単位となる。

### 1.2 評価者

- **自己評価者**
  - 対象者本人。
- **上司評価者**
  - 対象者の直属上司（既存の組織構造・上司情報に従う）。
- **同僚評価者（360 コアバリュー）**
  - 同じチーム/近いステージのメンバー。
  - アドミン設定により対象者ごとに 1 名〜任意数名を登録できる（デフォルト運用は 2 名）。

### 1.3 評定と点数

- **評定（Grade）**
  - 例: `SS`, `S`, `A+`, `A`, `A-`, `B`, `C`, `D` 等のラベル。
- **点数（Score）**
  - 各評定に対応する数値点。整数とし、既存仕様との兼ね合いから 0 以上の範囲（詳細な上限値は別途設計）。
- **評定マスタ**
  - 組織ごとに設定される「評定ラベル ↔ 点数」の対応表。
  - 評定ラベルの種類・名前・点数は組織ごとに完全に自由に増減・変更できる。

### 1.4 共通評価基準（例）

以下は、SS〜C の共通的な評価基準の一例であり、コアバリュー評価およびコンピテンシー評価において参照される前提とする（組織ごとにカスタマイズ可能）。

- `SS`: 全スタッフの上位 3% 以内に位置する。全社へ影響を与える卓越したレベル。
- `S`: 上位 10% 以内の望ましい行動レベルで、拠点を超えた影響を及ぼしている。
- `A+`: 上位 20% 以内の良好な行動レベルで、部門を超えた影響を持っている。
- `A`: 上位 30% 以内であり、部門内でのポジティブな影響が見られる。
- `A-`: 30％〜70% のレンジに位置し、個人レベルでの成果は認められる。自身からの積極的な影響に期待。
- `B`: 下位 30% のレベルで、他人からの影響を受けている状態。
- `C`: 下位 10% 以下に位置し、他人へのマイナスの影響を与えることがあるなど、早急な改善が必要。

---

## 2. 評定マスタ・点数対応表

### 2.1 機能要件

1. 組織ごとに以下を保持する。
   - 評定ラベル（例: `SS`, `S`, `A+`, `A`, `A-`, `B`, `C`, `D`）
   - 各評定ラベルに紐づく点数（例: `SS=7, S=6, A+=5, A=4, A-=3, B=2, C=1, D=0`）
2. 評定の種類（ラベル）は組織ごとに自由に増減可能とする。
   - 評定の追加（新しいラベルの定義）
   - 評定の削除
   - 既存評定の点数変更
3. 評定マスタは**バージョン管理**を行う。
   - 各変更（追加・削除・点数変更）は新しいバージョンとして保存する。
   - バージョンには少なくとも以下を持たせる。
     - `organization_id`
     - `version_id`（自動採番 UUID など）
     - 有効開始日時（または作成日時）
     - 作成者（アドミンユーザ ID）
     - 評定ラベルと点数のセット
4. 評価データ（自己評価・上司評価・360 評価）は、**評価時点の評定情報を固定で保持**する。
   - 各評価レコードには次を保存することが必須。
     - 選択された評定ラベル（例: `A`）
     - 評定に対応する点数（例: `4`）  
       → 評定マスタからコピーして保存し、後からマスタが変更されても再計算しない。
     - 評定マスタのバージョン ID
5. 評定マスタが更新された場合:
   - 以後に作成・更新される評価には新バージョンが使用される。
   - 過去に保存済みの評価レコードの点数には**一切反映しない**。

### 2.2 UI/UX 要件（アドミン）

1. 評定マスタ編集画面を提供する。
   - 組織単位で評定一覧（ラベル・点数・並び順）を表示。
   - ラベルの追加・削除・並び替え・点数変更が可能。
2. 保存時には必ず変更確認モーダルを表示する。
   - 変更内容のサマリ（例: `A: 4 → 5`, `B を削除` など）を表示。
   - 「この変更は既に行われた評価の点数には反映されません」という注意文を明示。
   - 誤操作防止のため、チェックボックスや簡易な確認入力（例: 組織名を入力）を用意する。
3. 評定マスタの履歴を閲覧可能にする。
   - 過去バージョンの一覧を表示（作成日時・作成者・構成）。
   - 過去の構成を参考にして、新たなバージョンとして再利用できる UI を検討する。

### 2.3 表示要件

- 一般ユーザー（自己評価・上司評価・同僚評価画面）:
  - 評定ラベルのみ表示し、数値点は表示しない。
- 管理画面（アドミン向け）:
  - 評定ラベルと点数を両方表示する。
  - 集計・レポート画面では点数を用いた合計・平均などの指標を表示可能とする。

---

## 3. 業績目標評価（自己評価・上司評価）

### 3.1 評価単位と既存モデルとの関係

- 業績目標は既存の `Goal` モデル（`goal_category = '業績目標'`）を利用する。
- 評価単位:
  - 1 つの業績目標ごとに、
    - 自己評価レコード 1 件
    - 上司評価レコード 1 件
  を作成する（1:1）。
- 現行の `SelfAssessment` / `SupervisorFeedback` は数値 rating のみを持つが、  
  本要件により「評定ラベル」「点数」「評定マスタバージョンID」を追加保存する DB 変更が必須である。

### 3.2 自己評価（業績目標）

#### 3.2.1 入力項目

対象者本人は、自分の業績目標一覧に対して、各目標ごとに以下を入力する。

- 評定
  - 評定マスタから 1 つ選択（必須）。
- コメント
  - 自由記述コメント（原則必須とする）。
- ステータス
  - 「ドラフト / 提出済」などの状態（現在の”目標”提出時と同様の機能）。

#### 3.2.2 保存内容

- `goal_id`
- `user_id`（対象者）
- `period_id`
- 評定ラベル
- 評定点数（評定マスタからコピー）
- 評定マスタバージョン ID
- コメント
- ステータス
- 作成日時・更新日時

#### 3.2.3 表示仕様

- 自己評価画面:
  - 評定ラベルのみ表示し、点数は表示しない。
  - コメントは本人・上司・アドミンから閲覧可能（アクセス制御は RBAC に従う）。

### 3.3 上司評価（業績目標）

#### 3.3.1 レコード生成

- 部下の自己評価が提出されたタイミングで、紐づく上司評価レコード（ドラフト状態）を自動生成する。
  - 既存の `supervisor_feedback` 自動生成フローを拡張して利用する。

#### 3.3.2 入力項目

上司は、部下の各業績目標ごとに以下を入力する。

- 評定
  - 評定マスタから 1 つ選択（必須）。
- コメント
  - 自由記述コメント（必須を推奨）。
- ステータス
  - 「ドラフト / 提出済」。

#### 3.3.3 保存内容

- `self_assessment_id` / `goal_id` / `period_id` / `supervisor_id`
- 評定ラベル
- 評定点数（評定マスタからコピー）
- 評定マスタバージョン ID
- コメント
- ステータス
- 作成日時・更新日時

#### 3.3.4 表示仕様

- 上司画面:
  - 評価関連アドミン設定に従い、部下の自己評価（評定ラベル・コメント）を表示するかどうかを制御する。
  - 上記設定が有効な場合、部下の自己評価（評定ラベル・コメント）と自身の上司評価（評定ラベル・コメント）を並べて表示可能。
  - 点数は表示しない。
- 部下の画面:
  - ロック期間中は、上司評価の評定・コメントは表示しない。
  - ロック解除後、評定ラベルとコメントを閲覧できる（点数は非表示）。

---

## 4. コンピテンシー評価（自己評価・上司評価）

### 4.1 評価単位

- コンピテンシーは「小項目」レベルで評価する。
- 各小項目に対して、自己評価・上司評価ともに「評定必須」とする。
- コメントは次のルールに従う。
  - 小項目ごとにはコメントを付けない。
  - すべてのコンピテンシーを総括するコメントを 1 件だけ入力する。
    - 自己評価: 対象者が 1 つの総括コメントを入力。
    - 上司評価: 上司が 1 つの総括コメントを入力。

### 4.2 想定データモデル（論理レベル）

#### 4.2.1 コンピテンシー小項目評価

- `CompetencyEvaluation`（仮称）
  - `organization_id`
  - `period_id`
  - `evaluatee_user_id`（対象者）
  - `evaluator_user_id`（評価者）
  - `evaluator_role`（自己; "self" / 上司; "supervisor"）
  - `competency_id`（Stage に紐づくコンピテンシー小項目）
  - 評定ラベル
  - 評定点数（評定マスタからコピー）
  - 評定マスタバージョン ID
  - ステータス（ドラフト / 提出済）
  - 作成日時・更新日時

#### 4.2.2 総括コメント

- `CompetencyEvaluationSummaryComment`（仮称）
  - `organization_id`
  - `period_id`
  - `evaluatee_user_id`
  - `evaluator_user_id`
  - `evaluator_role`（自己; "self" / 上司; "supervisor"）
  - 総括コメント本文
  - ステータス（ドラフト / 提出済）
  - 作成日時・更新日時

### 4.3 自己評価（コンピテンシー）

- 対象者は、自身のステージに紐づくすべてのコンピテンシー小項目について、評定を必ず入力する。
- 自己評価画面では:
  - 各小項目ごとに「評定ラベル」をドロップダウンより選択する UI を提供する。
  - 評価時には、1.4 で定義した共通評価基準（SS〜C の説明）を常に参照できる UI（固定サイドバーやヘルプパネル等）を表示する。
  - 小項目ごとのコメント欄は設けない。
  - 最下部に「全コンピテンシーに対する総括コメント」入力欄を 1 つだけ設ける。
- 入力完了後、「ドラフト保存」「提出」ができる。

### 4.4 上司評価（コンピテンシー）

- 部下のコンピテンシー自己評価提出後、上司は同じ小項目リストに対して評定を入力する。
- 上司評価画面では:
  - 評価関連アドミン設定に従い、各小項目ごとに「部下の自己評定」を表示するかどうかを制御する。
  - 上記設定が有効な場合、各小項目ごとに「部下の自己評定」と「上司評定」を並べて表示する。
  - 評価時には、1.4 で定義した共通評価基準（SS〜C の説明）を常に参照できる UI（固定サイドバーやヘルプパネル等）を表示する。
  - 上司側のみ操作可能な評定セレクトを提供。
  - 小項目のコメント欄は設けない。
  - 最下部に「コンピテンシー評価の総括コメント」入力欄を 1 つだけ設ける。

### 4.5 集計要件

- コンピテンシー小項目には、大項目（カテゴリ）情報を持たせる（既存のコンピテンシーの構成”大項目-小項目”を維持）。
- 集計は次の 2 段階で行う。
  1. **大項目ごとの総合評定**
     - 当該大項目に属する小項目の点数を集計し、平均点を算出する。
     - 平均点を評定マスタに基づき評定ラベルへ自動変換し、「大項目平均評定」として扱う。
     - 人手による上書きは行わない（自動集計のみ）。
  2. **全コンピテンシーの総合評定**
     - 全小項目（または大項目ごとの総合点）をもとに総合点を算出。
     - 同様に評定ラベルへ自動変換する（自動集計のみ）。
     - この評定を「全コンピテンシーの総合評定」として扱う。
- 表示要件:
  - 詳細評価画面において、各大項目のブロック単位で「大項目平均評定」（自動計算された評定ラベル）を表示する。
  - 同画面のフッタ付近に「全コンピテンシーの総合評定」（自動計算された評定ラベル）を表示する。
  - 自己評価・上司評価ともに、全コンピテンシーを総括するコメントを、この「全コンピテンシーの総合評定」の直下に配置する。
- これらの結果は、総合評価ビューおよび詳細評価画面で利用する。

---

## 5. 360 コアバリュー評価

### 5.1 特徴と前提

- コアバリューは「目標」としては存在しない。
  - `Goal` レコードを作成せず、「評価」のみ独立したデータ構造で扱う。
- 評価対象:
  - コアバリューに関する行動・姿勢を評価する。
  - 組織ごとに定義されたコアバリュー項目（例: 顧客志向, チームワーク 等）が存在する。
  - このコアバリューの項目を設定するデータベースやUIなどが新規で必要。（アドミンの組織設定ページで行う）
- 評価者:
  - 自己（対象者）
  - 上司
  - 同僚（アドミンが人数とメンバーを設定。1 名〜任意数名。デフォルトは２人）

### 5.2 評価項目と評価単位

- アドミンは「コアバリュー項目」を組織ごとに定義する。
  - 各項目は少なくとも以下を持つ。
    - `organization_id`
    - 項目名
    - 説明・評価基準テキスト（評価画面で常時表示）
    - 表示順
- 360 コアバリュー評価は、次の単位で作成される。
  - `CoreValueEvaluation`（仮称）
    - `organization_id`
    - `period_id`
    - `evaluatee_user_id`
    - `evaluator_user_id`
    - `evaluator_role`（自己; "self" / 上司; "supervisor" / 同僚; "colleague"）
    - `evaluation_scope`（"item" / "overall"）
    - `core_value_item_id`
    - 評定ラベル
    - 評定点数（評定マスタからコピー）
    - 評定マスタバージョン ID
    - ステータス（ドラフト / 提出済）
    - 作成日時・更新日時
    - `evaluation_scope = "item"` のレコードは自己評価者のみが持ち、`core_value_item_id` は必須とする（各コアバリュー項目ごとの自己評定）。
    - `evaluation_scope = "overall"` のレコードは自己 / 上司 / 同僚が持ち、`core_value_item_id` は NULL（または未設定）とし、コアバリュー全体に対する総合評定を表す。
- コメントは総括コメントとして別テーブルに保持する。
  - `CoreValueEvaluationSummaryComment`（仮称）
    - `organization_id`
    - `period_id`
    - `evaluatee_user_id`
    - `evaluator_user_id`
    - `evaluator_role`（自己; "self" / 上司; "supervisor" / 同僚; "colleague"）
    - コメント本文
    - ステータス（ドラフト / 提出済）
    - 作成日時・更新日時

### 5.3 入力仕様

- 自己評価:
  - 対象者はコアバリュー項目ごとに評定を入力（必須かどうかは運用に応じて決定）。
  - コメントは総括として 1 回のみ入力。
  - 評価画面では、各コアバリュー項目の内容とともに、1.4 で定義した共通評価基準（SS〜C の説明）を常に参照できる UI（固定サイドバーやヘルプパネル等）を表示する。
- 上司評価:
  - 上司は、対象者のコアバリュー全体に対する総合評定（1 つの評定ラベル）を入力する（個々のコアバリュー項目ごとの評定は行わない）。
  - コメントは総括として 1 回のみ入力。
  - 評価関連アドミン設定に従い、入力時に対象者の自己評価（各コアバリュー項目の評定ラベルおよび総合評定）を表示するかどうかを制御する（デフォルトは「表示しない」）。
  - 評価画面では、1.4 で定義した共通評価基準（SS〜C の説明）を常に参照できる UI を表示する。
- 同僚評価:
  - 各同僚は、対象者のコアバリュー全体に対する総合評定（1 つの評定ラベル）のみを入力する。
  - コメントは総括として 1 回のみ入力。
  - 評価関連アドミン設定に従い、入力時に対象者の自己評価（各コアバリュー項目の評定ラベルおよび総合評定）を表示するかどうかを制御する（デフォルトは「表示しない」）。
  - 評価画面では、1.4 で定義した共通評価基準（SS〜C の説明）を常に参照できる UI を表示する。

### 5.4 表示・匿名性

- 対象者（部下）が閲覧できる内容:
  - 自身の自己評価（評定ラベル・コメント）。
  - 上司評価（評定ラベル・コメント）※ロック期間後に公開。
  - 同僚評価については「同僚全員分の平均スコア（総合評定のみ）」を表示。
    - 個々の同僚ごとのスコアやコメント、評価者名は表示しない。
- 同僚評価者が閲覧できる内容:
  - 自分が入力した評価（評定 + コメント）のみ。
  - 他の同僚や上司の評価結果、対象者への最終評価は閲覧不可。
- 上司・アドミン:
  - 上司: 自身の評価 + 同僚評価の集計結果を閲覧可能。
  - アドミン: 必要に応じて全評価データ（評価者 ID を含む）にアクセス可能。
- 匿名性:
  - DB レベルでは誰が評価したか（`evaluator_user_id`）を保持する。
  - API / UI レイヤでレスポンスを制御することで、対象者や同僚からは評価者を特定できないようにする。
  - 詳細なアクセス権限マトリクス（誰がどのフェーズで何を見られるか）は別ドキュメントで整理する。

### 5.5 評価基準の管理

- コアバリューの評価基準（項目名・説明文など）は組織ごとに異なる前提。
- 評価関連のアドミン設定画面で、コアバリュー項目の追加・編集・削除・並び替えを行えるようにする。
- 評価画面では、各コアバリュー項目の評価基準を常時表示（固定サイドバー等）する。

---

## 6. ロック期間と公開タイミング

### 6.1 設定

- アドミンは「評価関連アドミン設定」で、評価結果の公開タイミングを設定できる。
- 設定単位:
  - 組織 × 評価期間
- 設定対象例:
  - 業績目標の上司評価公開開始日
  - コンピテンシー評価の上司評価公開開始日
  - 360 コアバリュー評価の公開開始日

### 6.2 挙動

- ロック期間中:
  - 対象者は自己評価のみ閲覧可能。
  - 上司評価・同僚評価（360 コアバリュー）は閲覧不可。
  - 上司・アドミンは常に自分の入力内容と必要な集計結果を閲覧可能。
- ロック解除後:
  - 対象者は、業績・コンピテンシー・コアバリューの評価結果を閲覧可能。
  - コアバリューの同僚評価は、匿名性ルール（平均値のみ表示など）を守った形で表示される。

### 6.3 評価入力時の他者評定表示設定

- アドミンは「評価関連アドミン設定」において、評価入力画面で他者の評定を表示するかどうかを評価種類ごとに制御できる。
- 設定単位:
  - 組織 × 評価期間 × 評価種類（業績目標（定量・定性） / コンピテンシー / 360 コアバリュー）
- 設定対象例:
  - 業績目標評価において、上司が評定を入力する際に、部下の自己評価（評定ラベル・コメント）を表示する / しない。
  - コンピテンシー評価において、上司が小項目ごとの評定を入力する際に、部下の自己評定（評定ラベル）を表示する / しない。
  - 360 コアバリュー評価において、上司が総合評定を入力する際に対象者の自己評価（各コアバリュー項目の評定ラベルおよび総合評定）を表示する / しない。
  - 360 コアバリュー評価において、同僚が総合評定を入力する際に対象者の自己評価（各コアバリュー項目の評定ラベルおよび総合評定）を表示する / しない。
- 上記設定は、各評価画面（3.3, 4.4, 5.3）の表示仕様・入力仕様に反映される。

---

## 7. 今後の詳細設計の前提

本ドキュメントで定義した要件に基づき、次の詳細設計を別途行う。

- 評定マスタ・バージョン管理用テーブル群の ER 設計と API 仕様
- 業績目標評価（自己・上司）の既存テーブル拡張（評定ラベル・点数・バージョン ID の追加）
- コンピテンシー評価専用テーブル群（小項目評価・総括コメント・集計ロジック）
- 360 コアバリュー評価専用テーブル群と評価者設定のデータモデル
- アクセス権限・匿名性を含む閲覧マトリクス（誰がいつ何を見られるか）

これらを段階的に実装しつつ、既存コードベース（FastAPI / Next.js）のサービス層・API 層・フロントエンドコンポーネントを順次対応させる。
