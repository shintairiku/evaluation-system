# 実装計画: RBAC統一化フレームワーク

> このドキュメントは、設計書に基づいてRBAC統一化フレームワークの実際の開発タスクを洗い出し、管理するためのものです。タスクは段階的導入を考慮して分割し、関連する要件を明記することで、進捗とトレーサビリティを確保します。

## Phase 1: 基盤フレームワークの実装

### 1. RBACHelperクラスのコア実装
> RBACフレームワークの中核となるヘルパークラスを実装します。既存のPermissionManagerと連携し、データフィルタリング機能を提供します。

- [x] **1.1. ResourceType列挙型とPermissionMapの定義**
  > backend/app/security/rbac_types.pyを作成し、リソースタイプの定義と権限マッピングを実装する。
  >
  > **関連要件:** 要件3 (リソース別アクセス制御パターン)

- [x] **1.2. RBACHelperクラスの基本構造**
  > backend/app/security/rbac_helper.pyを作成し、RBACHelperクラスの基本骨格を実装する。
  >
  > **関連要件:** 要件2 (役割ベースデータフィルタリングヘルパー)

- [x] **1.3. get_accessible_user_ids()メソッドの実装**
  > ユーザーの役割に応じてアクセス可能なユーザーIDリストを返すロジックを実装する。
  >
  > **関連要件:** 要件2 (役割ベースデータフィルタリングヘルパー)

- [x] **1.4. get_accessible_resource_ids()メソッドの実装**
  > 特定のリソースタイプに対するアクセス可能IDリストを返すロジックを実装する。
  >
  > **関連要件:** 要件3 (リソース別アクセス制御パターン)

- [x] **1.5. can_access_resource()メソッドの実装**
  > 特定リソースへの詳細なアクセス権限チェックを実装する。
  >
  > **関連要件:** 要件4 (条件付き権限チェック機能)

### 2. 権限チェックデコレーターの実装
> サービス関数に適用可能なデコレーターを実装し、単純な権限チェック機能を提供します。

- [x] **2.1. require_permission()デコレーターの実装**
  > backend/app/security/decorators.pyを作成し、単一権限要求デコレーターを実装する。
  >
  > **関連要件:** 要件1 (単純権限チェック用デコレーター)

- [x] **2.2. require_any_permission()デコレーターの実装**
  > 複数権限のいずれかを要求するデコレーターを実装する。
  >
  > **関連要件:** 要件1 (単純権限チェック用デコレーター)

- [x] **2.3. AuthContext抽出ユーティリティの実装**
  > デコレーター内でサービス関数の引数からAuthContextを自動抽出するヘルパーを実装する。
  >
  > **関連要件:** 要件1 (単純権限チェック用デコレーター)

### 3. キャッシュ機能とパフォーマンス最適化
> 部下関係取得などの重い処理をキャッシュし、パフォーマンスを最適化します。

- [x] **3.1. 部下関係キャッシュの実装**
  > cachetools.TTLCacheを使用した部下関係のキャッシュ機能を実装する。
  >
  > **関連要件:** 要件6 (パフォーマンス最適化)

- [x] **3.2. リソースアクセス結果キャッシュの実装**
  > 頻繁にアクセスされるリソース権限チェック結果をキャッシュする機能を実装する。
  >
  > **関連要件:** 要件6 (パフォーマンス最適化)

## Phase 2: テスト実装と品質保証

### 4. 単体テストの実装
> RBACフレームワークの各コンポーネントの動作を検証するテストを実装します。

- [x] **4.1. RBACHelperクラスのテスト実装**
  > backend/tests/security/test_rbac_helper.pyを作成し、各メソッドの動作を検証する。
  >
  > **関連要件:** 要件2, 要件3, 要件4

- [x] **4.2. デコレーターのテスト実装**
  > backend/tests/security/test_decorators.pyを作成し、権限チェックデコレーターを検証する。
  >
  > **関連要件:** 要件1

- [x] **4.3. 異なる役割による権限マトリックステスト**
  > 全ての役割（admin, manager, supervisor, employee等）と権限の組み合わせを網羅的にテストする。
  >
  > **関連要件:** 全要件

- [x] **4.4. エラーハンドリングテスト**
  > 権限不足やリソースアクセス拒否の際のエラー処理を検証する。
  >
  > **関連要件:** 要件7 (デバッグ・監査サポート)

### 5. パフォーマンステスト
> 既存実装との性能比較とパフォーマンス要件の検証を行います。

- [x] **5.1. ベースラインパフォーマンス測定**
  > 既存のサービス関数（get_users, get_goals等）のレスポンス時間を計測する。
  >
  > **関連要件:** 要件6 (パフォーマンス最適化)

- [x] **5.2. RBACフレームワーク導入後のパフォーマンス測定**
  > 新しいフレームワークを使用した場合のレスポンス時間を計測し、比較する。
  >
  > **関連要件:** 要件6 (パフォーマンス最適化)

- [x] **5.3. 負荷テストとキャッシュ効果の検証**
  > 同時アクセス時のパフォーマンスとキャッシュヒット率を検証する。
  >
  > **関連要件:** 要件6 (パフォーマンス最適化)

## Phase 3: 既存サービスとの統合

### 6. user_service.pyでの試験導入
> 最も複雑な権限ロジックを持つuser_serviceで新しいフレームワークを試験導入します。

- [x] **6.1. get_users()関数のリファクタリング**
  > 既存の複雑なif-elif-else権限ロジックをRBACHelper.get_accessible_user_ids()に置き換える。
  >
  > **関連要件:** 要件5 (サービス関数統合パターン)
  > **完了日:** 2025-09-04

- [x] **6.2. get_user_by_id()関数のリファクタリング**
  > リソースアクセスチェックをRBACHelper.can_access_resource()に置き換える。
  >
  > **関連要件:** 要件4, 要件5
  > **完了日:** 2025-09-04

- [x] **6.3. create_user()関数へのデコレーター適用**
  > @require_permission(Permission.USER_MANAGE)デコレーターを適用し、既存の権限チェックを簡素化する。
  >
  > **関連要件:** 要件1, 要件5
  > **完了日:** 2025-09-04

- [x] **6.4. update_user()関数の条件付き権限チェック統合**
  > 複雑な条件付き権限ロジック（自分自身または管理権限）をフレームワークに統合する。
  > **追加実装:** 詳細なフィールドレベル権限検証（USER_MANAGE_BASIC, USER_MANAGE_PLUS, USER_MANAGE）を実装。
  >
  > **関連要件:** 要件4, 要件5
  > **完了日:** 2025-09-04

**追加完了タスク（計画外だが重要）:**

- [x] **6.6. フィールドレベル権限システム実装**
  > USER_MANAGE_BASIC（name, job_title, department_id）、USER_MANAGE_PLUS（基本フィールド + subordinate_ids）、USER_MANAGE（全フィールド）の３段階権限を実装。
  > `RBACHelper.validate_user_update_fields()` メソッドを追加し、更新対象フィールドを動的に検証する機能を実装。
  >
  > **完了日:** 2025-09-04

- [x] **6.7. フロントエンド統合問題の解決**
  > フロントエンドが全フィールドを送信してしまい権限エラーが発生する問題を特定し、UserEditViewModal.tsxを修正。
  > 変更されたフィールドのみを送信するよう修正し、不要な権限エラーを解消。
  >
  > **完了日:** 2025-09-04

- [x] **6.8. 権限システムの詳細検証とデバッグ**
  > 実際のユーザー更新リクエストでの権限チェックを詳細に検証。
  > Permission enum vs 文字列での権限チェックの違いを特定・解決。
  >
  > **完了日:** 2025-09-04

- [x] **6.5. delete_user()関数へのデコレーター適用**
  > シンプルな権限チェックをデコレーターに置き換える。
  >
  > **関連要件:** 要件1, 要件5
  > **完了日:** 2025-09-04

### 7. 統合テストと後方互換性検証
> リファクタリング後の動作が既存の実装と一致することを検証します。

- [x] **7.1. 既存テストの実行と結果比較**
  > backend/tests/services/test_user_service.pyの既存テストが全て通ることを確認する。
  >
  > **関連要件:** 要件5 (サービス関数統合パターン)
  > **完了日:** 2025-09-04

- [x] **7.2. 各役割での動作検証**
  > admin, manager, supervisor, employee各役割でのuser_service動作を詳細に検証する。
  >
  > **関連要件:** 要件5
  > **完了日:** 2025-09-04

- [x] **7.3. エッジケースとエラー処理の検証**
  > 権限不足、存在しないリソース、無効なパラメーター等のエラーケースを検証する。
  >
  > **関連要件:** 要件7
  > **完了日:** 2025-09-04

## Phase 4: 他サービスへの展開

### 8. goal_service.pyへの展開
> 目標管理サービスに新しいRBACフレームワークを適用します。

- [ ] **8.1. get_goals()関数のデータフィルタリング統合**
  > 既存の_get_accessible_user_ids()ロジックをRBACHelperに統合する。
  >
  > **関連要件:** 要件2, 要件3

- [ ] **8.2. create_goal()、update_goal()関数へのデコレーター適用**
  > 目標の作成・更新権限チェックをデコレーター化する。
  >
  > **関連要件:** 要件1

- [ ] **8.3. 目標承認権限チェックの統合**
  > approve_goal()関数の複雑な権限ロジックをフレームワークに統合する。
  >
  > **関連要件:** 要件4

### 9. その他サービスへの順次展開
> 残りのサービス（評価、部門、レポート等）にフレームワークを適用します。

- [ ] **9.1. evaluation_service.pyへの展開**
  > 評価管理サービスに権限チェックとデータフィルタリングを統合する。
  >
  > **関連要件:** 要件2, 要件3, 要件4

- [ ] **9.2. department_service.pyへの展開**
  > 部門管理サービスに権限チェックを統合する。
  >
  > **関連要件:** 要件1, 要件3

- [ ] **9.3. assessment_service.pyへの展開**
  > 自己評価サービスに権限チェックとフィルタリングを統合する。
  >
  > **関連要件:** 要件2, 要件3

## 全般タスク

### 10. ドキュメント作成とログ機能

- [x] **10.1. 開発者向けドキュメントの作成**
  > backend/app/security/README.mdを更新し、新しいRBACフレームワークの使用方法を記述する。
  > **追加内容:** フィールドレベル権限検証、フロントエンド統合のトラブルシューティング、使用例を追加。
  >
  > **関連要件:** 要件5
  > **完了日:** 2025-09-04

- [ ] **10.2. 構造化ログ機能の実装**
  > structlogを使用した権限チェック・データアクセスのログ出力機能を実装する。
  >
  > **関連要件:** 要件7 (デバッグ・監査サポート)

- [ ] **10.3. マイグレーションガイドの作成**
  > 既存の権限チェックロジックを新しいフレームワークに移行するためのガイドを作成する。
  >
  > **関連要件:** 要件5

### 11. 最終検証とクリーンアップ

- [ ] **11.1. 全サービスでの統合テスト実行**
  > pytest backend/tests/ -v でバックエンドの全テストが通ることを確認する。

- [ ] **11.2. パフォーマンス最終検証**
  > 全サービスでのパフォーマンス要件達成を確認する。
  >
  > **関連要件:** 要件6

- [ ] **11.3. セキュリティ監査**
  > 権限バイパスの可能性がないかセキュリティ面での最終チェックを行う。
  >
  > **関連要件:** 全要件（セキュリティ観点）

- [ ] **11.4. 既存の冗長コードの削除**
  > リファクタリング完了後、不要になった旧権限チェックコードを削除する。
  >
  > **関連要件:** 要件5