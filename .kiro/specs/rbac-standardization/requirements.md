# 要件定義書: RBAC統一化フレームワーク

## 1. 概要
現在のHR評価システムのバックエンドサービス層では、役割ベースアクセス制御（RBAC）が各サービス関数で個別に実装されているが、統一された形式や構造が確立されていない。特に、単純な許可/拒否の判定だけでなく、ユーザーの役割に応じた条件付きデータフィルタリング（管理者は全データ、マネージャーは部下のデータのみ、従業員は自分のデータのみ等）が複雑に実装されている。

このプロジェクトの目的は：
- **一貫性の向上**: 権限チェックとデータフィルタリングの両方で統一されたパターンを確立
- **開発効率の向上**: 役割ベースの条件分岐ロジックを標準化し、新機能開発を簡素化
- **保守性の向上**: 権限ロジックを集約し、ビジネスルール変更時の修正箇所を最小化
- **セキュリティの強化**: データアクセス制御の漏れや不整合を防止

## 2. 要件一覧

### 要件1: 単純権限チェック用デコレーター

**ユーザーストーリー:**
> バックエンド開発者として、CREATE/UPDATE/DELETE操作などの単純な許可/拒否判定が必要なサービス関数に、簡単な権限チェックを追加したい。なぜなら、これらの操作は役割に関係なく一律で許可/拒否されるべきで、現在の個別実装では重複が多いからだ。

**受入基準:**
```gherkin
WHEN サービス関数に@require_permission(Permission.USER_MANAGE)デコレーターを適用する
THEN 呼び出し時に自動的に権限チェックが実行されること

WHEN 権限が不足しているユーザーがサービス関数を呼び出す
THEN PermissionDeniedErrorが自動的に発生すること

WHEN 複数の権限のいずれかが必要な場合(@require_any_permission)
THEN 指定した権限のうち一つでも持っていれば実行が許可されること
```

### 要件2: 役割ベースデータフィルタリングヘルパー

**ユーザーストーリー:**
> バックエンド開発者として、ユーザーの役割に応じて異なるデータフィルタリングを簡単に実装したい。なぜなら、現在のget_users()やget_goals()のような関数では、役割ごとに異なるuser_idsフィルターを適用する複雑なロジックが個別実装されているからだ。

**受入基準:**
```gherkin
WHEN RBACHelper.get_accessible_user_ids(auth_context, target_user_id)を呼び出す
THEN 現在のユーザーがアクセス可能なユーザーIDのリストが返されること

WHEN 管理者権限（USER_READ_ALL）を持つユーザーが呼び出す
THEN Noneまたは空のフィルター（全ユーザー対象）が返されること

WHEN 部下管理権限（USER_READ_SUBORDINATES）を持つユーザーが呼び出す
THEN そのユーザーの部下のIDリストが返されること

WHEN 自己読み取り権限（USER_READ_SELF）のみのユーザーが呼び出す
THEN そのユーザー自身のIDのみが含まれるリストが返されること
```

### 要件3: リソース別アクセス制御パターン

**ユーザーストーリー:**
> バックエンド開発者として、異なるリソースタイプ（ユーザー、目標、評価等）に対する標準化されたアクセス制御パターンを使いたい。なぜなら、各リソースで微妙に異なるアクセス制御ロジックが重複実装されており、保守が困難だからだ。

**受入基準:**
```gherkin
WHEN RBACHelper.get_accessible_resource_ids(auth_context, ResourceType.GOAL, target_user_id)を呼び出す
THEN 指定したリソースタイプに応じた適切なフィルタリング条件が返されること

WHEN 目標リソースに対してGOAL_READ_SUBORDINATESを持つユーザーが呼び出す
THEN 部下の目標IDのリストが返されること

WHEN 評価リソースに対してEVALUATION_READ_ALLを持つユーザーが呼び出す
THEN 全評価を対象とするフィルター条件が返されること
```

### 要件4: 条件付き権限チェック機能

**ユーザーストーリー:**
> バックエンド開発者として、複雑な条件（「自分自身のリソースまたは管理権限がある場合」等）での権限チェックを標準化したい。なぜなら、現在のサービス関数では、if文を組み合わせた複雑な権限判定ロジックが散在しているからだ。

**受入基準:**
```gherkin
WHEN RBACHelper.can_access_resource(auth_context, resource_id, ResourceType.USER)を呼び出す
THEN そのユーザーが特定のリソースにアクセス可能かどうかのブール値が返されること

WHEN ユーザーが自分自身のリソースにアクセスしようとする場合
THEN USER_READ_SELF権限があれば True が返されること

WHEN ユーザーが部下のリソースにアクセスしようとする場合
THEN USER_READ_SUBORDINATESがあり、かつ実際に部下関係がある場合のみ True が返されること
```

### 要件5: サービス関数統合パターン

**ユーザーストーリー:**
> バックエンド開発者として、既存のサービス関数の権限ロジックを段階的にリファクタリングできる統合パターンが欲しい。なぜなら、一度に全てのサービスを変更するのはリスクが高く、段階的な移行が必要だからだ。

**受入基準:**
```gherkin
WHEN 既存のget_users()関数にRBACHelperを導入する
THEN 現在の複雑なif-elif-else権限ロジックが、standardized helperの呼び出しに置き換えられること

WHEN 新しいヘルパーを使った実装と元の実装の結果を比較する
THEN 同じユーザー・権限の組み合わせで同じ結果が得られること

WHEN 一つのサービス関数のみをリファクタリングする
THEN 他のサービス関数に影響を与えないこと
```

### 要件6: パフォーマンス最適化

**要求事項:**
統一化されたRBACフレームワークは、現在の個別実装と比較してパフォーマンスの劣化を引き起こしてはならない。特に、部下関係の取得など重い処理については、適切なキャッシュ戦略を含むべきである。

**受入基準:**
```gherkin
GIVEN 同一ユーザーが複数回部下リストを参照する状況で
WHEN RBACHelper.get_accessible_user_ids()を複数回呼び出す
THEN データベースクエリが重複実行されず、キャッシュが活用されること

GIVEN 100の同時リクエストがある状態で
WHEN 権限チェック付きのサービス関数を呼び出す
THEN 現在の実装と比較してレスポンス時間が10%以上遅くならないこと
```

### 要件7: デバッグ・監査サポート

**要求事項:**
権限チェックとデータフィルタリングの結果は、デバッグとセキュリティ監査のために適切にログ出力されるべきである。

**受入基準:**
```gherkin
GIVEN ログレベルがDEBUGに設定されている状態で
WHEN RBACHelperの権限チェック機能が実行される
THEN ユーザーID、チェック対象リソース、適用された権限、結果が構造化ログで出力されること

WHEN データフィルタリングが実行された場合
THEN フィルタリング前後のデータ数、適用されたフィルター条件がログに記録されること

WHEN 権限チェックが失敗した場合
THEN 失敗理由、要求された権限、ユーザーの実際の権限がログに記録されること
```