# 要件定義書: Custom JWT Token Enhancement with Organization Support

## 1. 概要

現在のClerkアカウントページで定義されているカスタムJWTトークンは、内部ユーザーIDのみを提供しています。バックエンドサービスはAuthContentを通じてユーザー情報を簡単に取得できますが、フロントエンドコンポーネントはできません。この問題を解決するため、JWTトークンにユーザー情報を追加し、同時にClerkで組織機能を有効化します。これにより、組織ベースのマルチテナントアプリケーションとして機能し、管理者機能も実装可能になります。

## 2. 要件一覧

### 要件1: カスタムJWTトークンの拡張

**ユーザーストーリー:**
> フロントエンド開発者として、JWTトークンから直接ユーザー情報（内部ユーザーID、メール、ロール、組織ID、組織名）を取得したい。なぜなら、毎回APIを呼び出すことなく、クライアントサイドでユーザー情報に基づく表示制御を行いたいからだ。

**受入基準:**
```gherkin
WHEN ユーザーがログインした時
THEN JWTトークンにuser_id、email、role、organization_id、organization_nameが含まれること

WHEN フロントエンドコンポーネントがJWTトークンをデコードした時
THEN 追加のAPIコールなしでユーザー情報にアクセスできること

WHEN JWTトークンの内容を確認した時
THEN セキュリティ上重要でない情報のみがpublic metadataに含まれていること
```

### 要件2: Clerkメタデータの管理

**ユーザーストーリー:**
> システム管理者として、ユーザーのサインアップ時とメタデータ更新時に、適切な情報がClerkのメタデータに保存されることを確認したい。なぜなら、JWTトークンの内容とアプリケーションの状態を同期させる必要があるからだ。

**受入基準:**
```gherkin
WHEN ユーザーがサインアップした時
THEN public metadataにusers_table_idとrole（初期値"employee"）が設定されること

WHEN ユーザーがサインアップした時
THEN private metadataにemail、organization_id、organization_nameが設定されること

WHEN アプリケーション内でユーザー情報が更新された時
THEN 対応するClerkメタデータも自動的に更新されること
```

### 要件3: 組織機能の有効化

**ユーザーストーリー:**
> 組織の管理者として、自分の組織のユーザーのみを管理できるマルチテナント環境を利用したい。なぜなら、他の組織のデータにアクセスできないセキュアな環境が必要だからだ。

**受入基準:**
```gherkin
WHEN Clerkで組織機能が有効化された時
THEN 各ユーザーは特定の組織に所属すること

WHEN ユーザーがアプリケーションにアクセスした時
THEN 自分の組織のデータのみが表示されること

WHEN 組織が作成された時
THEN その組織のadmin prefixを持つ管理者機能が利用可能になること
```

### 要件4: 管理者機能の実装

**ユーザーストーリー:**
> 組織の管理者として、admin prefixが付いたページパスとAPIエンドポイントを通じて、管理者専用機能にアクセスしたい。なぜなら、一般ユーザーとは異なる権限で組織を管理する必要があるからだ。

**受入基準:**
```gherkin
WHEN 管理者ロールのユーザーが/adminで始まるパスにアクセスした時
THEN 管理者専用ページが表示されること

WHEN 一般ユーザーが/adminで始まるパスにアクセスした時
THEN アクセス拒否されること

WHEN APIエンドポイントに/api/adminプレフィックスが付いている時
THEN 管理者ロールのユーザーのみがアクセス可能であること
```

### 要件5: バックエンドエンドポイントの更新

**ユーザーストーリー:**
> バックエンド開発者として、既存のすべてのエンドポイントが組織IDと組織名を適切に処理できるようにしたい。なぜなら、マルチテナント環境でデータの分離を確保する必要があるからだ。

**受入基準:**
```gherkin
WHEN 既存のAPIエンドポイントが呼び出された時
THEN JWTトークンから組織IDを取得してデータをフィルタリングすること

WHEN ロールベースアクセス制御が適用された時
THEN サービス層で適切な権限チェックが行われること

WHEN 新しい管理者向けエンドポイントが作成された時
THEN 適切なミドルウェアによって管理者権限がチェックされること
```

### 要件6: 非機能要件 - セキュリティとパフォーマンス

**要求事項:**
- JWTトークンには機密情報を含めず、public/private metadataの適切な分離を行うこと
- 組織間のデータ漏洩を防ぐため、すべてのデータアクセスで組織IDによるフィルタリングを実装すること
- メタデータの更新は即座にJWTトークンに反映されること

**受入基準:**
```gherkin
GIVEN ユーザーが組織Aに所属している状態で
WHEN 任意のAPIエンドポイントを呼び出した時
THEN 組織Bのデータにはアクセスできないこと

GIVEN メタデータが更新された状態で
WHEN ユーザーが次回ログインした時
THEN 最新の情報がJWTトークンに含まれていること
```